import{Q as F}from"./QSpinnerDots-CS0bZHc0.js";import{r as f,B as A,a9 as $,h as b,o as y,g as P,c as N,J as z,aj as H,u as j,a as Z,w as u,m as K,d as n,L as G,M as R,e as _,j as J,t as X,ae as O,Q,f as s}from"./index-CdXKqIwE.js";import{u as B,Q as Y}from"./use-quasar-BVv1AXdb.js";import{_ as L,b as q,Q as W}from"./_plugin-vue_export-helper-BlM1Smyy.js";import{u as ee}from"./session-store-D5-E9gTF.js";import{M as ae,T as te}from"./ThreadPanel-EO4UZi4g.js";import"./axios-CpKrHKbl.js";const re={class:"helper-video-player"},oe=["src"],ne={__name:"HelperVideoPlayer",props:{videoId:{type:String,required:!0}},emits:["currentTimeUpdate","durationUpdate"],setup(U,{expose:v,emit:S}){const t=U,m=S,i=B(),a=f(null),d=f(0);let l=null;A(()=>{k()}),$(()=>{l&&clearInterval(l),a.value&&a.value.destroy()});function k(){if(window.YT&&window.YT.Player){p();return}if(!window.YT&&!document.querySelector('script[src*="youtube.com/iframe_api"]')){const r=document.createElement("script");r.src="https://www.youtube.com/iframe_api";const e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(r,e)}window.onYouTubeIframeAPIReady||(window.onYouTubeIframeAPIReady=()=>{window.ytCallbacks&&(window.ytCallbacks.forEach(r=>r()),window.ytCallbacks=[])},window.ytCallbacks=[]),window.ytCallbacks=window.ytCallbacks||[],window.ytCallbacks.push(p)}function p(){if(console.log("Initializing helper YouTube player with video ID:",t.videoId),!t.videoId||t.videoId.length!==11){console.error("Invalid video ID:",t.videoId),i.notify({type:"negative",message:"Invalid video ID format. Please check the YouTube URL.",icon:"error"});return}a.value=new window.YT.Player("helper-youtube-player",{events:{onReady:M,onStateChange:C,onError:I}})}function I(r){console.error("YouTube Player Error:",r.data);let e="Video playback error";r.data===100?e="Video not found or is private":r.data===101||r.data===150?e="This video cannot be embedded. Please try a different video.":r.data===2?e="Invalid video parameter":r.data===5&&(e="HTML5 player error. Try refreshing the page."),i.notify({type:"negative",message:e,caption:`Error code: ${r.data}`,icon:"error",timeout:5e3})}function M(){if(a.value&&a.value.getDuration){const e=a.value.getDuration();m("durationUpdate",e)}const r=D();r>0&&a.value.seekTo(r,!0),l=setInterval(()=>{a.value&&a.value.getCurrentTime&&(d.value=a.value.getCurrentTime(),m("currentTimeUpdate",d.value),x(d.value))},250)}function C(r){if(r.data===window.YT.PlayerState.ENDED){const e=a.value.getDuration();a.value.seekTo(e-.1,!0),a.value.pauseVideo()}}function g(){return`video-position-${t.videoId}`}function x(r){try{localStorage.setItem(g(),r.toString())}catch(e){console.warn("Failed to save video position:",e)}}function D(){try{const r=localStorage.getItem(g());return r?parseFloat(r):0}catch(r){return console.warn("Failed to retrieve video position:",r),0}}function E(r){a.value&&a.value.seekTo&&a.value.seekTo(r,!0)}function T(){a.value&&a.value.playVideo&&a.value.playVideo()}function w(){a.value&&a.value.pauseVideo&&a.value.pauseVideo()}function V(){a.value&&(a.value.getPlayerState()===1?w():T())}return v({seekToTime:E,play:T,pause:w,togglePlayPause:V,getCurrentTime:()=>d.value}),(r,e)=>(y(),b("div",re,[P("iframe",{id:"helper-youtube-player",src:`https://www.youtube.com/embed/${t.videoId}?enablejsapi=1&modestbranding=1&rel=0`,style:{border:"0"},allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:""},null,8,oe)]))}},se=L(ne,[["__scopeId","data-v-9476f1cf"]]),ie={key:0,class:"row justify-center q-pa-xl"},le={key:1,class:"row justify-center"},ue={class:"text-h6"},de={key:2,class:"session-container"},ce={class:"vertical-layout"},me={class:"row items-center q-gutter-sm q-mb-md"},fe={__name:"HelperSessionPage",setup(U){const v=j(),S=B(),t=ee(),m=f(!0),i=f(null),a=f(null),d=f(null),l=N(()=>!t.selectedMarker||!t.markers.length?-1:t.markers.findIndex(e=>e.id===t.selectedMarker.id)),k=N(()=>l.value>0),p=N(()=>l.value>=0&&l.value<t.markers.length-1);z(()=>t.selectedMarker,e=>{e&&a.value&&a.value.seekToTime(e.start_time)}),A(()=>{I(),window.addEventListener("keydown",r)}),H(()=>{t.clearSession(),window.removeEventListener("keydown",r)});async function I(){m.value=!0,i.value=null;try{const e=v.query.token;if(!e){i.value="Token is required";return}d.value=e;const o=await q.getSession(v.params.id,e);if(o.role!=="helper"){i.value="This URL is for helpers only";return}t.setSession(o)}catch(e){i.value=e.response?.data?.error||e.message||"Failed to load session"}finally{m.value=!1}}async function M(){try{const e=await q.getSession(v.params.id,d.value);t.updateSession(e)}catch{S.notify({type:"negative",message:"Failed to refresh session",icon:"error"})}}function C(e){t.setSelectedMarker(e)}function g(){if(k.value){const e=t.markers[l.value-1];t.setSelectedMarker(e)}}function x(){if(p.value){const e=t.markers[l.value+1];t.setSelectedMarker(e)}}function D(e){a.value&&a.value.seekToTime(e)}function E(e){if(a.value){const o=t.currentTime,c=Math.max(0,o+e);a.value.seekToTime(c)}}function T(e){a.value&&(a.value.seekToTime(e),a.value.play())}function w(){a.value&&a.value.togglePlayPause()}function V(e){if(!e)return"";const o=[/[?&]v=([a-zA-Z0-9_-]{11})/,/youtu\.be\/([a-zA-Z0-9_-]{11})/,/embed\/([a-zA-Z0-9_-]{11})/,/\/v\/([a-zA-Z0-9_-]{11})/];for(const c of o){const h=e.match(c);if(h&&h[1])return console.log("Extracted video ID:",h[1],"from URL:",e),h[1]}return console.error("Failed to extract video ID from URL:",e),""}function r(e){if(e.code==="Space"||e.key===" "){const o=e.target;if(o.tagName==="INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable)return;e.preventDefault(),a.value&&a.value.togglePlayPause()}}return(e,o)=>(y(),Z(W,{class:"q-pa-md"},{default:u(()=>[m.value?(y(),b("div",ie,[n(F,{color:"secondary",size:"50px"})])):i.value?(y(),b("div",le,[n(G,{style:{"max-width":"500px",width:"100%"}},{default:u(()=>[n(R,{class:"bg-negative text-white"},{default:u(()=>[P("div",ue,[n(J,{name:"error"}),o[2]||(o[2]=_(" Error Loading Session",-1))])]),_:1}),n(R,null,{default:u(()=>[_(X(i.value),1)]),_:1}),n(O,{align:"right"},{default:u(()=>[n(Q,{flat:"",label:"Go Home",to:"/",color:"primary"})]),_:1})]),_:1})])):s(t).session?(y(),b("div",de,[P("div",ce,[n(se,{ref_key:"videoPlayerRef",ref:a,"video-id":V(s(t).session.youtube_url),onCurrentTimeUpdate:o[0]||(o[0]=c=>s(t).setCurrentTime(c)),onDurationUpdate:o[1]||(o[1]=c=>s(t).setVideoDuration(c)),class:"q-mb-md"},null,8,["video-id"]),P("div",me,[n(Q,{round:"",icon:"chevron_left",onClick:g,disable:!k.value,color:"primary"},{default:u(()=>[n(Y,null,{default:u(()=>[...o[3]||(o[3]=[_("Previous marker",-1)])]),_:1})]),_:1},8,["disable"]),n(ae,{markers:s(t).markers,"current-time":s(t).currentTime,duration:s(t).videoDuration,"selected-marker":s(t).selectedMarker,onMarkerClick:C,onSeek:D,class:"col"},null,8,["markers","current-time","duration","selected-marker"]),n(Q,{round:"",icon:"chevron_right",onClick:x,disable:!p.value,color:"primary"},{default:u(()=>[n(Y,null,{default:u(()=>[...o[4]||(o[4]=[_("Next marker",-1)])]),_:1})]),_:1},8,["disable"])]),n(te,{marker:s(t).selectedMarker,markers:s(t).markers,role:"helper",token:d.value,onPostCreated:M,onMarkerSelected:s(t).setSelectedMarker,onSeek:E,onPlayFromMarker:T,onTogglePlayPause:w},null,8,["marker","markers","token","onMarkerSelected"])])])):K("",!0)]),_:1}))}},he=L(fe,[["__scopeId","data-v-8d116a6a"]]);export{he as default};
